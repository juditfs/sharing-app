# ShareSafe - Supabase Configuration

## Local Development Setup

### Prerequisites
- Node.js 18+ and npm
- Supabase CLI

### Install Supabase CLI

```bash
# macOS
brew install supabase/tap/supabase

# Or via npm
npm install -g supabase
```

### Initialize Local Supabase

```bash
# Start local Supabase (Docker required)
supabase start

# This will output:
# - API URL
# - Anon Key
# - Service Role Key
# - Studio URL (local dashboard)
```

### Apply Migrations

```bash
# Apply database migrations
supabase db reset

# Or apply specific migration
supabase migration up
```

### Deploy Edge Functions Locally

```bash
# Serve all functions locally
supabase functions serve

# Or serve specific function
supabase functions serve create-link
```

## Cloud Deployment

### Link to Cloud Project

```bash
# Login to Supabase
supabase login

# Link to your cloud project
supabase link --project-ref <your-project-ref>
```

### Deploy Migrations

```bash
# Push migrations to cloud
supabase db push
```

### Deploy Edge Functions

```bash
# Deploy all functions
supabase functions deploy

# Or deploy specific function
supabase functions deploy create-link
supabase functions deploy get-link
```

### Set Environment Secrets

```bash
# Edge functions automatically have access to:
# - SUPABASE_URL
# - SUPABASE_SERVICE_ROLE_KEY
# - SUPABASE_ANON_KEY

# No additional secrets needed for prototype
```

## Configuration Files

### supabase/config.toml
Contains project configuration (auto-generated by `supabase init`)

### Environment Variables

Create `.env.local` in project root:

```env
# Get these from Supabase Dashboard > Settings > API
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# For mobile app (Expo)
EXPO_PUBLIC_SUPABASE_URL=your-project-url
EXPO_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

## Enable Anonymous Auth

### Via Supabase Dashboard
1. Go to Authentication > Settings
2. Enable "Anonymous sign-ins"
3. Save changes

### Via SQL (if needed)
```sql
-- Anonymous auth is enabled by default in newer Supabase versions
-- No additional configuration needed
```

## Storage Bucket Setup

The `photos` bucket is created automatically via migration.

### Verify Bucket Configuration
1. Go to Storage in Supabase Dashboard
2. Confirm `photos` bucket exists
3. Confirm it's set to **Private** (not public)
4. RLS policies are applied via migration

## Edge Function API Reference

### POST /functions/v1/create-link

Creates a new shareable link for an encrypted photo.

**Authentication**: Required (Bearer token)

**Request Body**:
```json
{
  "photoUrl": "string (required)",
  "thumbnailUrl": "string (optional)",
  "encryptionKey": "string (required)"
}
```

**Field Specifications**:
- `photoUrl`: Storage path to encrypted photo (e.g., `user-id/photo-abc123.jpg`)
- `thumbnailUrl`: Storage path to encrypted thumbnail (optional)
- `encryptionKey`: 64 hexadecimal characters (32 bytes) - AES-256 key

**Success Response** (200):
```json
{
  "shortCode": "aBc12XyZ",
  "shareUrl": "http://localhost:3000/share/aBc12XyZ"
}
```

**Error Responses**:
- `400 Bad Request`: Missing required fields or invalid encryption key format
- `401 Unauthorized`: Missing or invalid authorization header
- `500 Internal Server Error`: Failed to create link or store encryption key

**Example**:
```bash
curl -X POST 'https://your-project.supabase.co/functions/v1/create-link' \
  -H 'Authorization: Bearer YOUR_ANON_KEY' \
  -H 'Content-Type: application/json' \
  -d '{
    "photoUrl": "550e8400-e29b-41d4-a716-446655440000/photo.jpg",
    "thumbnailUrl": "550e8400-e29b-41d4-a716-446655440000/thumb.jpg",
    "encryptionKey": "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"
  }'
```

---

### GET /functions/v1/get-link

Retrieves link metadata or encryption key for a shared photo.

**Authentication**: Not required (public endpoint)

**Query Parameters**:
- `shortCode` (required): 8-character link code
- `action` (required): Either `metadata` or `key`

**Action: 'metadata'**

Returns signed URL and metadata for the photo.

**Success Response** (200):
```json
{
  "signedUrl": "https://...storage.supabase.co/...?token=...",
  "thumbnailUrl": "https://...storage.supabase.co/...?token=...",
  "metadata": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "createdAt": "2026-01-19T12:00:00Z"
  }
}
```

**Notes**:
- Signed URLs are valid for 60 seconds
- `thumbnailUrl` is optional (only if thumbnail exists)

**Action: 'key'**

Returns the encryption key for decrypting the photo.

**Success Response** (200):
```json
{
  "key": "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"
}
```

**Error Responses**:
- `400 Bad Request`: Missing or invalid parameters
- `404 Not Found`: Link not found or encryption key not found
- `500 Internal Server Error`: Failed to generate signed URL

**Examples**:
```bash
# Get metadata
curl 'https://your-project.supabase.co/functions/v1/get-link?shortCode=aBc12XyZ&action=metadata'

# Get encryption key
curl 'https://your-project.supabase.co/functions/v1/get-link?shortCode=aBc12XyZ&action=key'
```

---

## Testing Edge Functions

### Test create-link

```bash
curl -X POST 'http://localhost:54321/functions/v1/create-link' \
  -H 'Authorization: Bearer YOUR_ANON_KEY' \
  -H 'Content-Type: application/json' \
  -d '{
    "photoUrl": "user-id/photo.jpg",
    "encryptionKey": "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"
  }'
```

### Test get-link

```bash
# Get metadata
curl 'http://localhost:54321/functions/v1/get-link?shortCode=abc123&action=metadata'

# Get key
curl 'http://localhost:54321/functions/v1/get-link?shortCode=abc123&action=key'
```

## Troubleshooting

### Port Conflicts
If ports are already in use:
```bash
supabase stop
supabase start
```

### Reset Database
```bash
supabase db reset
```

### View Logs
```bash
# Edge function logs
supabase functions logs create-link

# Database logs
supabase db logs
```

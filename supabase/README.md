# ShareSafe - Supabase Configuration

## Local Development Setup

### Prerequisites
- Node.js 18+ and npm
- Supabase CLI

### Install Supabase CLI

```bash
# macOS
brew install supabase/tap/supabase

# Or via npm
npm install -g supabase
```

### Initialize Local Supabase

```bash
# Start local Supabase (Docker required)
supabase start

# This will output:
# - API URL
# - Anon Key
# - Service Role Key
# - Studio URL (local dashboard)
```

### Apply Migrations

```bash
# Apply database migrations
supabase db reset

# Or apply specific migration
supabase migration up
```

### Deploy Edge Functions Locally

```bash
# Serve all functions locally
supabase functions serve

# Or serve specific function
supabase functions serve create-link
```

## Cloud Deployment

### Link to Cloud Project

```bash
# Login to Supabase
supabase login

# Link to your cloud project
supabase link --project-ref <your-project-ref>
```

### Deploy Migrations

```bash
# Push migrations to cloud
supabase db push
```

### Deploy Edge Functions

```bash
# Deploy all functions
supabase functions deploy

# Or deploy specific function
supabase functions deploy create-link
supabase functions deploy get-link
```

### Set Environment Secrets

```bash
# Edge functions automatically have access to:
# - SUPABASE_URL
# - SUPABASE_SERVICE_ROLE_KEY
# - SUPABASE_ANON_KEY

# No additional secrets needed for prototype
```

## Configuration Files

### supabase/config.toml
Contains project configuration (auto-generated by `supabase init`)

### Environment Variables

Create `.env.local` in project root:

```env
# Get these from Supabase Dashboard > Settings > API
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# For mobile app (Expo)
EXPO_PUBLIC_SUPABASE_URL=your-project-url
EXPO_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

## Enable Anonymous Auth

### Via Supabase Dashboard
1. Go to Authentication > Settings
2. Enable "Anonymous sign-ins"
3. Save changes

### Via SQL (if needed)
```sql
-- Anonymous auth is enabled by default in newer Supabase versions
-- No additional configuration needed
```

## Storage Bucket Setup

The `photos` bucket is created automatically via migration.

### Verify Bucket Configuration
1. Go to Storage in Supabase Dashboard
2. Confirm `photos` bucket exists
3. Confirm it's set to **Private** (not public)
4. RLS policies are applied via migration

## Testing Edge Functions

### Test create-link

```bash
curl -X POST 'http://localhost:54321/functions/v1/create-link' \
  -H 'Authorization: Bearer YOUR_ANON_KEY' \
  -H 'Content-Type: application/json' \
  -d '{
    "photoUrl": "user-id/photo.jpg",
    "encryptionKey": "abcd1234..."
  }'
```

### Test get-link

```bash
# Get metadata
curl 'http://localhost:54321/functions/v1/get-link?shortCode=abc123&action=metadata'

# Get key
curl 'http://localhost:54321/functions/v1/get-link?shortCode=abc123&action=key'
```

## Troubleshooting

### Port Conflicts
If ports are already in use:
```bash
supabase stop
supabase start
```

### Reset Database
```bash
supabase db reset
```

### View Logs
```bash
# Edge function logs
supabase functions logs create-link

# Database logs
supabase db logs
```
